<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>趣学-听力</title>

    <link rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/styles/app.css">

    <script src="//cdn.jsdelivr.net/g/jquery@3.2.1,bootstrap@3.3.7,vue@2.3.2"></script>
</head>
<body>
<div class="container" id="listening-recall" v-cloak>
    <div class="row">
        <div class="col-xs-12">
            <div class="panel panel-success">
                <div class="panel-heading text-nowrap">
                    <a href="index.html">趣学</a> / <a href="listening.html">听力</a>
                </div>
                <div class="panel-body">
                    <template v-if="text">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-xs-10">
                                    <span class="glyphicon glyphicon-volume-up" @click="playAudio"></span>
                                    <audio id="audio"></audio>
                                </div>
                                <div class="col-xs-2">
                                    <span class="glyphicon glyphicon-bell" @click="tip"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <form class="form-inline">
                                        <blockquote>
                                            <p>

                                                <template v-for="(item, index) in text">
                                                    {{ item }}
                                                    <template v-if="index < answers.length">
                                                        <div class="form-group" name="subject-div">
                                                            <input name="subject-input" class="form-control"
                                                                   :size="answers[index].length - 2"
                                                                   v-model.trim="results[index]">
                                                        </div>
                                                    </template>
                                                </template>

                                            </p>
                                            <footer v-if="tipTranslation">{{ translation }}</footer>
                                        </blockquote>
                                    </form>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 text-center">
                                    <template v-if="hasNext()">
                                        <button type="button" class="btn btn-success" @click="next">下一个
                                        </button>
                                    </template>
                                    <template v-else>
                                        <a class="btn btn-success" href="listening.html" role="button">结束</a>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var ids = (function () {
        var reg = new RegExp("(^|&)ids=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        return r ? decodeURIComponent(r[2]).split(",") : [];
    })();

    var vm = new Vue({
        "el": "#listening-recall",
        "data": {
            "index": -1,
            "answers": [],
            "results": [],
            "text": [],
            "translation": "",
            "tipTranslation": false
        },
        "watch": {
            "results": function () {
                for (var index in this.answers) {
                    var answer = this.answers[index];
                    var result = this.results[index];

                    if (answer && result) {
                        var divElement = $("div[name='subject-div']").get(index);
                        var inputElement = $("input[name='subject-input']").get(index);

                        var answerText = answer.toLocaleLowerCase();
                        var resultText = result.toLocaleLowerCase();

                        if (answerText.indexOf(resultText) == 0) {
                            $(divElement).removeClass("has-error").addClass("has-success");
                        } else {
                            $(divElement).removeClass("has-success").addClass("has-error");
                        }

                        if (answerText === resultText) {
                            $(inputElement).attr("readonly", true);
                        }
                    }
                }
            }
        },
        "methods": {
            "hasNext": function () {
                return this.index < ids.length - 1;
            },
            "next": function () {
                this.select(this.index + 1);
            },
            "select": function (index) {
                var wordContent = ids[index];
                $.get(["assets", "listening", wordContent, wordContent + ".json"].join("/"), function (value) {
                    vm.index = index;
                    vm.answers = value.answers;
                    vm.results = [];
                    vm.text = value.text;
                    vm.translation = value.translation;
                    vm.tipTranslation = false;
                });
            },
            "tip": function () {
                if (!!this.text) {
                    if (!this.tipTranslation) {
                        this.tipTranslation = true;
                        return;
                    }

                    $("input[name='subject-input']").each(function (index) {
                        var answer = vm.answers[index];
                        $(this).val(answer);
                    });

                    window.setTimeout(function () {
                        $("input[name='subject-input']").each(function (index) {
                            var results = vm.results[index];
                            $(this).val(results);
                        });
                    }, 1000 * this.answers.length);
                }
            },
            "playAudio": function () {
                var wordContent = ids[this.index];
                $("#audio").attr({
                    "src": ["assets", "listening", wordContent, wordContent + ".mp3"].join("/"),
                    "autoplay": "autoplay"
                });
            }
        }
    });

    vm.hasNext() && vm.next();

    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-103657912-1', 'auto');
    ga('send', 'pageview');
</script>
</body>
</html>
